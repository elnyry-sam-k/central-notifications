Notification service
====================
The notification service provides support for notifications based on configured criteria such as Net Debit Cap changes or reaching a threshold on the Net Debit Cap or such others.

stories
-------
* [#517 - Notification for changes to NetDebitCap or Position adjustments](https://github.com/mojaloop/project/issues/517)
* [#518 - Notification for approaching Net Debit Cap Threshold](https://github.com/mojaloop/project/issues/518)

tasks
--------
* receive urgent notifications and ?requests?
* sends notifications based on configs to dfsps
* receives config updates
* receives position updates on the smallest period of warnings into the configs for all dfsps (json view)
* logging? what and where?

reacts on 
----------------------
* notification configs changes - the data won't serve any other purpose but to config notification engines so why not JSON?
  * settings for different threshold alarms, channels of delivery etc.
* urgent notifications - kafka msg routed to the engine based on the lowest critical level stored in the central database 
* positions/limits/NDC or any other type of changes in sensitive data - why not get it as a big JSON view document with all dfsps
  * get it by direct central database access / kafka-admin-topic / http request to central-ledger

data
----
* configs
* views
* urgent notifications

local storage and central database
-----------------------------------
* can we use mysql json data type on central database or string in mysql?
* the view can be generated by running the same query over and over again, which is optimised by sql db enginge.
* central database `limits and threshold` table to store only the value of critical levesl(% of NCP/value?) for urgent notifications and id/address of the latest received config or config itself
* if we decide to have local storage it can be key:value or document storage
  * we can use the view idea for reporting on later stage
  * we can deliver views for different dashboard apps for admin and troubleshooting purposes to the dfsps. HUB admin might be connected to the central database for live data
  * we can use this storage for enums/pointers or other references to the central database to offload it a bit (no updates of pointers for example, no enum queries from different functionalities)

actors
-------------------
* central-ledger
* notification-router
* notification-engine

technologies
------------
* [napajs](https://github.com/Microsoft/napajs) for process management into the notification services
* [node-schedule](https://www.npmjs.com/package/node-schedule) for scheduling tasks


connections
-------------------
|central-ledger| connection |notification-router| connection |notification-engine|
|-|-|-|-|-|
|kafka-admin-topic| <->|config|||              
|kafka-notification-topic|<->|urgent notificaions|||
|central-database |<-| creating dashboard view||| 
||| local storage for configs and view | <->| sends notifications based on delta |
|||napajs? sockets? kafka?| <->| receives and acts on urgent notifications|

* central-ledger
  * API to support setting threshold(s) for Notifications/Alerts (config)
  * compare current critical level with new critical level from config and act on it
  * produce urgent notifications if critical level is reached
  
* notification-router
  * connected to central-ledger
    * kafka (admin topics) - config changes, json dashboard data?
    * kafka notification topic
    * local storage
    * central database access (for view or maybe view from kafka admin topic? not really time reliable)
  * connected to notification-engine for sending urgent messages (napajs/kafka/http)

* notification-engine(s)
  * spawn notification-engine per dfsp as a worker process (napajs) or another docker container (how it will communicate with router in that case)
  * connected to the local storage
    * without local storage we need connection to the router for requests to the central database or direct connection to the central database
  * runs scheduled processes - based on config, requests data received by the router with the dashboard json view and reacts on urgent notifications
    * [node-schedule](https://www.npmjs.com/package/node-schedule)
  * operates different channels to reach dfsp (email/sms/etc)

View - example 
--------------
```
{
  timestamp: 
  dfspsViews: [
    dfsp1: {
      curentNDC:
      position:
      ......

    },
    dfsp2: {

    }
  ]
}
```
urgent notifications flow overview
----------------------------------
1. central ledger creates urgent notification on kafka-notification-topic
2. router receives the notification and sends to particular engine
3. engine acts based on config (maybe not send same notificaion more than 3 times in an hour)

view processing flow overview
-----------------------------
1. router gets the view from central database on given period and stores it into local storage
2. enginge gets the view from local storage on its own period (might be bigger)
3. engine compares old view with the new one and gives delta
4. engine process delta and config and creates actions based on positives
5. engine acts

